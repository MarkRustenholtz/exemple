<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CR Gendarmerie</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  body { font-family: Arial, sans-serif; margin: 10px; max-width: 900px; margin-left: auto; margin-right: auto; background: #fff; color: #222; }
  h1,h2,h3 { text-align:center; }
  label { display: block; margin: 6px 0 3px 0; }
  input[type=text], input[type=date], input[type=time], select {
    width: 100%; padding: 6px 8px; box-sizing: border-box;
    border-radius: 4px; border: 1px solid #aaa; font-size: 1em;
  }
  button { cursor: pointer; font-weight: bold; border: none; border-radius: 6px; padding: 6px 12px; font-size: 1.1em; margin: 4px 2px; min-width: 36px; min-height: 36px; user-select:none; transition: background-color 0.2s ease; }
  button.plusminus { width: 48px; border-radius: 10px; font-size: 1.5em; }
  button.plusminus:hover { background-color: #ddd; }
  button.red { background-color: #d9534f; color: white; }
  button.red:hover { background-color: #c9302c; }
  button.blue { background-color: #3498db; color: white; }
  button.blue:hover { background-color: #217dbb; }
  .flex-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .flex-col { flex: 1 1 200px; min-width: 200px; }
  .vehicle-card { border: 2px solid #3498db; border-radius: 10px; padding: 12px; margin-bottom: 18px; background: #f9fafe; }
  .vehicle-card h3 { margin-top: 0; color: #2c3e50; }
  .manual-input { width: 80px; font-size: 1em; padding: 4px 6px; }
  textarea { width: 100%; min-height: 80px; font-family: monospace; font-size: 1em; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; resize: vertical; }
  hr { border: 0; border-top: 1.5px solid #ccc; margin: 18px 0; }
  .small-note { font-size: 0.85em; color: #666; margin-top: -6px; margin-bottom: 12px; }
  @media (max-width: 768px) {
    .header-inputs { display: flex; flex-wrap: wrap; gap: 6px; }
    .header-inputs label { flex: 1 1 30%; font-size: 0.9em; }
    .header-inputs input { width: 100%; padding: 4px; font-size: 1em; }
  }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<h1>CR Gendarmerie - LIMES Breil  La Turbie  DSI Tende</h1>

<!-- üîπ toutes tes sections originales (infos, ESR, mat√©riel, v√©hicules, ESI, Passeur, Observations, D√©roulement, Pulsar) inchang√©es -->

<hr/>

<section style="text-align:center; margin-bottom: 20px;">
  <button id="generateBtn" style="background-color:#3498db; color:white; font-weight:bold; padding: 10px 20px; font-size:1.2em;">G√©n√©rer compte rendu</button>
  <button id="copyBtn" style="background-color:#27ae60; color:white; font-weight:bold; padding: 10px 20px; font-size:1.2em;">Copier dans le presse-papiers</button>
  <button id="resetBtn" class="red" style="font-size:1.2em;">Effacer les donn√©es sauvegard√©es</button>
  <button id="scanQrBtn">Scanner QR</button>
  <div id="qr-reader" style="width:300px; margin-top:10px; display:none;"></div>
</section>

<section>
  <h2>R√©sum√© des ESR :</h2>
  <textarea id="qrResume" readonly rows="10" style="font-family: monospace; white-space: pre-wrap;"></textarea>
</section>

<section>
  <h2>Compte rendu g√©n√©r√© :</h2>
  <textarea id="compteRendu" readonly rows="20" style="font-family: monospace; white-space: pre-wrap;"></textarea>
</section>

<script>
(() => {
  const state = {
    site: '', date: '', heureDebut: '', heureFin: '',
    esrList: [],
    cameraNum: '', cameraESR: '',
    tablette1Num: '', tablette1ESR: '',
    tablette2Num: '', tablette2ESR: '',
    vehiculeService: '',
    vehicules: { train: 0, bus: 0, vl: 0, pl: 0 },
    cv: { train: 0, bus: 0, vl: 0, pl: 0 },
    cf: { train: 0, bus: 0, vl: 0, pl: 0 },
    esiList: [], passeurList: [],
    observations: '', deroulement: '', pulsar: '',
    resume: '', scannedNigends: []
  };

  // --- Sauvegarde ---
  function saveToStorage() { localStorage.setItem('crGendarmerie', JSON.stringify(state)); }
  function loadFromStorage() {
    const data = localStorage.getItem('crGendarmerie');
    if(data) Object.assign(state, JSON.parse(data));
  }

  // --- QR CODE ---
  function processQRCode(qrText) {
    if(!qrText || qrText.trim() === "") { alert("QR code vide ou invalide !"); return; }
    if(state.scannedNigends.includes(qrText)) { alert("Ce QR code a d√©j√† √©t√© scann√© !"); return; }

    const nigendMatch = qrText.match(/NIGEND\s*:\s*(\d+)/i);
    if(!nigendMatch) { alert("QR Code non reconnu !"); return; }
    const nigendNumber = nigendMatch[1];
    const esrNigends = state.esrList.map(e => e.nigend);
    if(!esrNigends.includes(nigendNumber)) { alert("Ce QR code ne correspond √† aucun ESR renseign√© !"); return; }

    // Ajout des valeurs
    const regex = /(Train|Bus|Vl|Pl):\s*(\d+)\s*\/\s*(\d+)\s*CV\s*\/\s*(\d+)\s*CF/gi;
    let match;
    while((match = regex.exec(qrText)) !== null) {
      const type = match[1].toLowerCase();
      state.vehicules[type] += parseInt(match[2]);
      state.cv[type] += parseInt(match[3]);
      state.cf[type] += parseInt(match[4]);
    }

    // Ajout dans le r√©sum√©
    state.scannedNigends.push(qrText);
    state.resume += "\n\n" + qrText;
    document.getElementById('qrResume').value = state.resume.trim();

    saveToStorage();
  }

  function safeProcessQRCode(text) {
    try { processQRCode(text); }
    catch(e) { alert("Erreur QR : " + e.message); }
  }

  // --- Bouton scan ---
  document.getElementById('scanQrBtn').addEventListener('click', () => {
    const qrReader = document.getElementById('qr-reader');
    qrReader.style.display = 'block';
    const html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => { safeProcessQRCode(decodedText); },
      (errorMessage) => {}
    ).catch(err => console.error(err));
  });

  // --- G√©n√©ration du CR ---
  function generateCompteRendu() {
    if(!state.date) { alert('Merci de s√©lectionner une date.'); return; }
    const site = state.site;
    const date = state.date.split('-').reverse().join('/');
    const heureDebut = state.heureDebut || '';
    const heureFin = state.heureFin || '';
    const esrCount = state.esrList.length;

    let cr = `LIMES ${site} - CR - ${date} - ${heureDebut} √† ${heureFin}\n\n`;

    cr += `(${esrCount}) ESR\n`;
    state.esrList.forEach((esr,i) => {
      cr += `${i+1} ${esr.grade} - ${esr.nom} - ${esr.nigend} - CRT ${esr.crt}\n`;
    });

    cr += `\nPorteur cam√©ra n¬∫ ${state.cameraNum} : ${state.cameraESR || ''}\n`;
    cr += `Tablette n¬∫ T${state.tablette1Num} : ${state.tablette1ESR || ''}\n`;
    if(state.tablette2Num.trim() !== '') cr += `Tablette n¬∫ T${state.tablette2Num} : ${state.tablette2ESR || ''}\n`;
    if(state.vehiculeService.trim() !== '') cr += `V√©hicule de service : ${state.vehiculeService}\n`;

    // üîπ Ici les TOTAUX incluent aussi les QR codes
    cr += `\n1 - MOYENS / PERSONNES:\n`;
    ['train','bus','vl','pl'].forEach(type => {
      const vCount = state.vehicules[type];
      const cvCount = state.cv[type];
      const cfCount = state.cf[type];
      cr += `- ${type.toUpperCase()}: ${vCount} / ${cvCount} CV / ${cfCount} CF\n`;
    });

    const totalVehicules = ['train','bus','vl','pl'].reduce((a,t) => a + state.vehicules[t], 0);
    const totalPersonnes = ['train','bus','vl','pl'].reduce((a,t) => a + state.cv[t] + state.cf[t], 0);
    cr += `\nTOTAL MOYENS : ${totalVehicules}\n`;
    cr += `TOTAL PERSONNES : ${totalPersonnes}\n`;

    document.getElementById('compteRendu').value = cr;
  }

  document.getElementById('generateBtn').addEventListener('click', generateCompteRendu);

  // --- Init ---
  loadFromStorage();
})();
</script>
</body>
</html>
